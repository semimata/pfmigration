= 食品流通プラットフォーム移行計画書
:lang: ja
:doctype: book
:author: システム技術部　クラウド開発課
:revnumber: 1.0
:version-label: バージョン
:revdate: 2022年10月20日
:toc: left
:toclevels: 3
:toc-title: 目次
:sectnums:
:chapter-signifier: 章
:sectnumlevels: 4
:table-caption: 表
:imagesdir: images
//:nofooter: yes

== 本書の目的
本計画書は、軽量化プラットフォームへの移行を実現するにあたり、以下の計画について記述するものである

* システム移行概要
* 移行実施体制と役割

また本計画書は初版作成後に、移行リハーサルの実施結果を受けて、より精度の高い計画を策定するべく改版を行うことを前提とする

=== 用語の定義
本計画書で使用する用語の定義を示す。

.用語
[cols="2,7",width=100%]
|===
|用語|説明
|リハーサル環境|STGおよび本番環境の移行作業を検証する環境。作成した手順書の確認jを行う。リハーサル環境構成はSTG環境と同じ構成とする
|STG環境|本番環境にリリースするプログラム稼働を確認する環境
|本番環境|お客様向けサービスを提供する環境
|切り戻し|現行の食品流通プラットフォームから軽量化プラットフォームへの切り替え中に重大なトラブルなどが発生し、軽量化プラットフォームでの稼動が見込めなくなったとき、切り替えを中止して元の状態に戻し、現行の食品流通プラットフォームでの稼動を続行すること
|コンティンジェンシープラン|コンティンジェンシープランとは、「不測の事態」に対して策定する計画
|バックアップ|「とある時点のデータの写しを保存しておく」ことを指す
|要冷機器監視システム|冷蔵ロッカーの遠隔監視、管理システム
|===

== システム移行概要
 現在利用している食品流通プラットフォームは、コンテナ環境を利用しているため利用頻度がすくないサービスではクラウドの利用費用が高くなる。現在の要冷機器監視システムの利用頻度を踏まえて、食品流通プラットフォームをコンテナ基盤からサーバレスを利用した軽量化プラットフォームへ移行する。

=== 前提条件

- 環境

今回のシステム移行ではアカウント変更（移行）は行わず、現在のアカウント内でシステム移行を行う。

- 運用・監視

今回のシステム移行では監視項目、運用作業の見直し追加は実施しない。

=== 移行全体概要
image::migration_overall.jpg[]

[%always]
<<<

=== 移行イメージ

==== アプリケーション移行

軽量化プラットフォームのアプリケーション移行イメージを以下に示す。 +

* 要冷機器監視システムのLambda入れ替え
* Secret Mangerリソースの追加
** 環境変数の削除

image::lambda-migration.png[]

[%always]
<<<

==== インフラ移行
軽量化プラットフォームのインフラ移行イメージを以下に示す。 +

* 軽量化プラットフォーム移行に不要となるリソース削除

image::infra-migration.png[]

=== システム移行方針

- アプリケーション

 軽量化プラットフォーム移行に合わせて要冷蔵機器監視システムの一部を改修し、軽量化プラットフォームに導入する。

- インフラ

 軽量化プラットフォーム移行後も現行のインフラリソースは利用する。ただし、例外があるため、以下に整理する。

[%always]
<<<

=== クラウドリソース・サービス移行方針

[cols="1,1,3a",width=100%]
|===
|クラウドリソース|移行方針|補足
|Lambda|一部停止|
* 軽量化PF移行に際し、要冷機器監視システムのLambdaの修正を実施
* 共通サービスと提供済みのLambdaは停止
|仮想サーバ(EC2)|停止|踏み台サーバも停止
|API Gateway|一部停止|
* コンテナサービスを呼び出すAPI Gatewayは停止
* Device Serverを呼び出すAPI Gatewayは停止
* 上記以外は継続利用
|カスタムドメイン|継続利用|
|Cloudfront|継続利用|
|RDS|停止|
|DynamoDB|一部停止|共通サービスで利用しているテーブルは停止
|S3|一部停止|コンテナ環境情報を保持しているS3は停止
|VPC link|停止|
|Transit Gateway|停止|
|Route53|継続利用|
|ACM|継続利用|
|SES|継続利用|
|SQS|継続利用|
|CloudWatch|継続利用|
|WAF|継続利用|
|NAT Gateway|停止|
|VPC|一部停止|コンテナデプロイ環境は停止
|CloudTrail|継続利用|
|Config|継続利用|

|===

=== 段階的なシステム移行
システム移行はSTG環境および本番環境への影響を考慮し、以下のステップで実施する。

[cols="1,3a",width=100%]
|===
|ステップ|移行内容
|ステップ１（2022年度）|

* 実施すること
** プラットフォームの移行
** AWSリソースの廃止（削除）
* 実施しないこと
** AWSアカウント移行

|ステップ２（2023年度）|

* 実施すること
** AWSアカウント移行
** 監視、運用項目の追加（必要に応じて）

|===

[%always]
<<<

=== 移行全体スケジュール案
移行作業の全体スケジュールは以下に示す

image::schedule.jpg[]

[%always]
<<<

=== システム移行詳細

- プラットフォーム移行期間

各環境の移行作業を以下の期間で実施する

|===
|環境|開始|終了
|リハーサル環境|2022年10月31日|2022年10月31日
|STG環境|2022年12月5日|2022年12月5日
|本番環境|2023年2月6日|2022年2月7日
|===

- 移行作業詳細

各環境で実施する移行作業を分担を示す

[cols="2,2, 2, 4,1,1",width=100%]
|===
|項目|実施日時|作業|内容|日本|大連
.3+|リハーサル移行
.3+|10月31日
|バックアップ取得|システム移行後も利用するデータのバックアップを取得する|〇|
|移行作業|軽量化プラットフォームのアプリをリリースする|〇|〇
|稼働確認|軽量化プラットフォームに移行後のアプリケーションの稼働確認を行う|〇|〇
.4+|STG環境移行
.2+|12月5日
|バックアップ取得|システム移行後も利用するデータのバックアップを取得する |〇|
|移行作業|軽量化プラットフォームのアプリをリリースする||〇
|12月5日|稼働確認|軽量化プラットフォームに移行後のアプリケーションの稼働確認を行う |〇|〇
|12月13日|不要リソース削除|軽量化PF移行後に不要となるクラウドのリソースを削除する|〇|
.4+|本番環境移行
.2+|2月5日
|バックアップ取得|システム移行後も利用するデータのバックアップを取得する|〇|
|移行作業|軽量化プラットフォームのアプリをリリースする||〇
|2月6日|稼働確認|軽量化プラットフォームに移行後のアプリケーションの稼働確認を行う|〇|〇
|2月13日|不要リソース削除|軽量化PF移行後に不要となるクラウドのリソースを削除する|〇|
|===

[%always]
<<<

- システム移行の開始・完了基準

* 今回のシステム移行を実施するにあたり、各工程の開始、終了基準を設定する。
* 各移行工程の開始・完了基準を以下に示す。

[cols="1,1,1,1,4,1",width=100%]
|===
.2+|工程
3+^.^|環境
.2+^.^|判定基準
.2+^.^|補足
^|リハ ^|STG ^|本番
.6+|開始基準
^|〇 ^|- ^|-|移行環境の構築が完了している|
^|〇 ^|〇 ^|〇|移行手順書が関係者でレビューか完了している|
^|〇 ^|〇 ^|〇|レビュー会議で指摘された内容が移行手順書に反映されている|
^|〇 ^|〇 ^|〇|移行作業に必要なリソースの準備が完了している|
^|〇 ^|〇 ^|〇|移行作業時の体制、コミュニケーションルールが規定されている|
^|〇 ^|〇 ^|-|移行作業の予想時間が設定されている|
.4+|完了基準
^|〇 ^|〇 ^|-|課題が整理され対応策が決定している|
^|〇 ^|〇 ^|〇|移行手順書に記載した作業がすべて終了している|
^|〇 ^|〇 ^|〇|移行後のサービス稼働確認が日本・大連で終了している|
^|〇 ^|〇 ^|-|移行作業時の時間計測が完了している（リハーサル、STG環境）|
|===

=== 要冷機器監視システムのサービス停止期間およびサービス再開日時

STG環境および本番環境のサービス停止期間およびサービス再開日時を以下とする。

image::stg-open-close.jpg[]

image::prod-open-close.jpg[]

[%always]
<<<

=== コンティンジェンシープラン

今回のシステム移行（本番移行）の作業中に「不測の事態」が発生した場合でも切り戻しは行わない。

=== 移行リハーサルの概要

- 移行リハーサルの目的

* 移行手順書の最終確認
* 移行作業連絡体制の確認
* 本番移行時の想定時間の確定

- 移行リハーサルの環境

* STG環境、本番環境と同等の環境を使用する
* クラウド利用費用を踏まえて冗長化構成は行わない

- 移行リハーサル結果を移行手順書へ反映

 移行リハーサル結果を確認し、移行手順や実施時間などに不備がある場合は、移行手順書に反映する。

- 移行リハーサルの実施回数

* リハーサル回数は1回とする
* 完了基準を充足しない場合のみ、2回目のリハーサルを実施する

== 移行実施体制と役割

=== 体制

image::migration_structure.jpg[]

=== 役割

移行体制図に記述した各担当の役割を示す。

[cols="1,4",width=100%]
|===
|役割|担当内容
|統括責任者|移行作業の開始許可、完了承認など作業の開始・終了基準の判断を行う
|PMO|移行作業の推進、アプリケーション稼働確認を行う
|責任者|アプリ・インフラ領域の移行作業の手順書レビュー、作業結果の確認を行う
|担当者|アプリ・インフラ領域の移行作業の手順書作成、作業を行う
|===
